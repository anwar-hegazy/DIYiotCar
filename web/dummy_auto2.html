<html>
<head>
  <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- sb-admin CSS -->
    <link href="css/sb-admin.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/custom.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<script src="js/pixi.min.js"></script>
<!-- <script src="js/testData.js"></script> -->

<script>

(function(g,b,d){var c=b.head||b.getElementsByTagName("head"),D="readyState",E="onreadystatechange",F="DOMContentLoaded",G="addEventListener",H=setTimeout;
function f(){

// ***************************************************************
// *********************** $LAB stuff ****************************
// ***************************************************************
$LAB.script("js/jquery-2.1.1.js").wait()
        .script("js/autobahn.js").wait()
    	.script("js/diy_auto.js").wait()
    	.script("js/plugins/jquery-ui-1.11.2.custom/jquery-ui.js").wait() 
    //	.script("js/kinetic/kinetic-v5.1.0.js").wait() 
        .wait(function(){
                // ***************************************************************
                // *********************** scripts ok  ***************************
                // ***************************************************************
         	AUTOBAHN_DEBUG = true;
 		ab.debug(true);
 		var diy_o =  new diy_tools();
        	$(function(){   
			/* 
			 * ******************************************
			 * get token and connect to  wss 
			 * connect is using fro data read from device 
			 * ******************************************
			*/ 
			var promiseToken = diy_o.getToken();
			promiseToken.done(function (data) {
				diy_o.access_token = data.access_token;
				var promiseDevices = diy_o.getDevices();
				promiseDevices.success(function (devices) {
					$.each(devices.result.dev, function(i, item) {
						$('<div id="diy_'+item.device+'" class="diy_devices">'+item.device+'</div>').appendTo('#devices');
						console.log('Devices:"' + item.device);	
						//$("[name='deviceselection']").append('<option value='+item.device+'>'+item.device+'</option>');
					});
				});
			});
			$(document).on('click', '.diy_devices', function() {
			//$("#gobutton").on('click', function() {
				//var id = "diy_" + $("[name='deviceselection']").val(); //$(this).attr('id');
				var id = $(this).attr('id');
				//var device= $("[name='deviceselection']").val(); //id.substr(4)
				var device= id.substr(4)
				console.log('Devices:' + device);	
				promiseToken.done(function (data) {
					diy_o.device = device;
					//diy_o.device = "kittensCategory";
					diy_o.access_token = data.access_token;
					diy_o.wss_connect();
				});
			});
			$(document).on('click', '.mpros', function() {
				var id = $(this).attr('id');
				promiseToken.done(function (data) {
					diy_o.access_token = data.access_token;
					diy_o.device = "auto";
					diy_o.exec = 'startauto';
					diy_o.diyexec();
				});
			});
                        $(document).on('click', '.stop', function() {
                                var id = $(this).attr('id');
                                promiseToken.done(function (data) {
                                        diy_o.access_token = data.access_token;
                                        diy_o.device = "auto";
                                        diy_o.exec = 'stopauto';
                                        diy_o.diyexec();
                                });
                        });

  		});
                // ***************************************************************
                // *********************** scripts ok  ***************************
                // ***************************************************************
        });
// ***************************************************************
// *********************** $LAB stuff  ***************************
// ***************************************************************

}
H(function(){if("item"in c){if(!c[0]){H(arguments.callee,25);return}c=c[0]}var a=b.createElement("script"),e=false;a.onload=a[E]=function(){if((a[D]&&a[D]!=="complete"&&a[D]!=="loaded")||e){return false}a.onload=a[E]=null;e=true;f()};
a.src="js/LAB.js";
c.insertBefore(a,c.firstChild)},0);if(b[D]==null&&b[G]){b[D]="loading";b[G](F,d=function(){b.removeEventListener(F,d,false);b[D]="complete"},false)}})(this,document);


</script>

</head>
<body>
<div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Arduino@net</a>
            </div>
            
            <!-- Sidebar Menu Items - These collapse to the responsive navigation menu on small screens -->
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav side-nav">
                    <li>
                        <a href="index.html">Home</a>
                    </li>
                    <li>
                        <a href="example-page1.html">Example page 1</a>
                    </li>
                     <li>
                        <a href="example-page2.html">Example page 2</a>
                    </li>
					<li>
                        <a href="register.html">Register</a>
                    </li>
					<li>
                        <a href="login.html">Login</a>
                    </li>
                    <li>
                        <a href="javascript:;" data-toggle="collapse" data-target="#demo">Dropdown<i class="fa fa-fw fa-caret-down"></i></a>
                        <ul id="demo" class="collapse">
                            <li class="active">
                                <a href="dropdown_item_1.html">Example Dropdown Item 1</a>
                            </li>
                            <li>
                                <a href="dropdown_item_2.html">Example Dropdown Item 2</a>
                            </li>
							<li>
                                <a href="blank-page.html">Blank page</a>
                            </li>
                            <li>
                                <a href="tables.html">Tables</a>
                            </li>
							<li>
                                <a href="forms.html">Forms</a>
                            </li>
							<li>
                                <a href="charts.html">Charts</a>
                            </li>
							<li>
                                <a href="bootstrap-grid.html">Bootstrap grid</a>
                            </li>
							<li>
                                <a href="bootstrap-elements.html">Bootstrap elements</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </nav>
<div id="page-wrapper">

	<div class="container-fluid">

	<!-- Page Heading -->
	<div class="row">
		<div class="col-lg-12">
			<h1 class="page-header">
				Devices
			</h1>
	  </div>
	</div>

	<div id="devices" class="devices">
	</div>
	<br />
	
	<div id="mpros" class="mpros table-responsive">mpros</div>
	<div id="stop" class="stop table-responsive">stop</div>
    <div id="canvas"></div>



	<div id="dataDev" class="dataDev table-responsive">
		<table class="table table-hover">
			<thead id="listheaders" style="font-weight: bold;">
			</thead>
			<tbody id="listtable">
			</tbody>
		</table>
	</div>
	<div id="dataDev1" class="dataDev1 table-responsive">
    </div>
	
	
	</div>
			  
			  
</div>
</div>

<script>

    var renderer = PIXI.autoDetectRenderer(800, 600,{backgroundColor : 0x1099bb});
    document.getElementById('canvas').appendChild(renderer.view);

   
    var stage = new PIXI.Container(),
	     tracks = new PIXI.Container (),
	     path = new PIXI.Container (),
	     obstacles = new PIXI.Container (),
	     panel = new PIXI.Container ();
		 
		stage.interactive = true;
	    panel.interactive = true;
	    //path.interactive = false; // gia arxi

		// create a texture from an image path
    var texture = PIXI.Texture.fromImage('img/car.png');

    // create a new Sprite using the texture
    var car = new PIXI.Sprite(texture);
    // enable the car to be interactive... this will allow it to respond to mouse and touch events
    car.interactive = true;
    // this button mode will mean the hand cursor appears when you roll over the car with your mouse
    car.buttonMode = true;
	// center the sprite's anchor point
    car.anchor.x = 0.5;
    car.anchor.y = 0.5;
	// setup events
    car.on('click', showTrack);
    car.on('tap', showTrack);
		
        // events for drag start
       // car.on('mousedown', onDragStart)
        //car.on('touchstart', onDragStart)
        // events for drag end
       // .on('mouseup', onDragEnd)
        //.on('mouseupoutside', onDragEnd)
       // .on('touchend', onDragEnd)
       // .on('touchendoutside', onDragEnd)
        // events for drag move
       // .on('mousemove', onDragMove)
      //  .on('touchmove', onDragMove);
		
	
	// set scale for the car 
	car.scale.x = car.scale.y = 0.8;
		
    //set starting postition
    car.position.x = 200;
    car.position.y = 150;
	car.rotation = 0;
    //add car to stage
    stage.addChild(car);
	
// path Areaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
	 var pathArea = new PIXI.Graphics (); // clickable area.....
	pathArea.lineStyle(0);
    pathArea.beginFill(0xFFFFFF, 0.2);
    pathArea.drawRect (0, 0, 800, 600);
	pathArea.visible=false;
	pathArea.interactive = false;
		
	pathArea.click = function(mouseData)
	{
		console.log ("Add new path point!!!");
	}
	
	path.addChild(pathArea);
	//path.zIndex = 1;
   stage.addChild (path);   // add to main stage
	
	
	// 2 empodia proxeiro*********************************
	var graphics2 = new PIXI.Graphics();
	graphics2.lineStyle(1, 0x000000);
	graphics2.beginFill(0xFFFF0B, 0.5);
	graphics2.drawCircle(470, 90,5);
	graphics2.drawCircle(300, 90,5);
    graphics2.endFill();
	
	obstacles.addChild(graphics2);
	// add obstacles to stage
	stage.addChild (obstacles); 
	
	// tracks****************************************
	var graphics3 = new PIXI.Graphics();
	graphics3.lineStyle(1, 0x000000);
	graphics3.beginFill(0xFFFF0B, 0.5);
	
	// tracks.addChild(graphics3);
	stage.addChild (tracks); //******************************************
	
	
	// panel 2 buttons to pathArea sto path.container !!! gia visible +/-
	var btnSet = new PIXI.Graphics();
	var btnSend = new PIXI.Graphics();	
	
	
	var btnText = new PIXI.Text("Set", {font:"20px Arial", fill:"red"});
	btnText.x = 690;
	btnText.y = 15;
	panel.addChild(btnText);
	btnSet.lineStyle (2, 0xFF00FF, 1);
	btnSet.beginFill (0x006600, 0.25);
	btnSet.drawRoundedRect(680, 10, 50, 40, 15);
	btnSet.endFill();
	panel.addChild(btnSet);
	
	btnSet.interactive = true;
	
	btnSet.click=function(mouseData)
	{
		console.log("Start an Set!");	
		this.alpha = 1;
		
			pathArea.visible = true;
			pathArea.interactive = true;
			
//		pathArea.click = function(mouseData)
//	{
//		console.log ("Add new path point!!!");
//	}
	
			//tracks.addChild(graphics3);
			//stage.addChild (tracks);
	}
	btnSet.mousedown=function(mouseData)
	{
		this.alpha = 0.25;
	}

	var btnText = new PIXI.Text("Send", {font:"20px Arial", fill:"red"});
	btnText.x = 740;
	btnText.y = 15;
	panel.addChild(btnText);
	btnSend.lineStyle (2, 0xFF00FF, 1);
	btnSend.beginFill (0xFF00BB, 0.25);
	btnSend.drawRoundedRect(740, 10, 50, 40, 15);
	btnSend.endFill();
	panel.addChild(btnSend);
	
	btnSend.interactive = true;
	
	btnSend.click=function(mouseData)
	{
		console.log("Clear and Send!");
		this.alpha = 1;
		pathArea.interactive = false;
		pathArea.visible = false;
		
		 //tracks.removeChildren();
		//tracks.updateCache();
		
	/*
		for (var i = tracks.children.length - 1; i >= 0; i--) 
		{
		tracks.removeChild(stage.children[i]);
		};
		stage.addChild (tracks);
		*/
		
		
		//EMPTYING ARRAY ------> pointMesh.length = 0;
	}  
	btnSend.mousedown=function(mouseData)
	{
		this.alpha = 0.25;
	}
	
  stage.addChild (panel);   // add to main stage
 
//***************************************************************************************************************** 
 //   var pathArea = new PIXI.Graphics (); // clickable area.....
//	pathArea.hitArea = new PIXI.Rectangle (0,0,800,560); // mporei kai me metabliti width ktl...

//	pathArea.interactive = true;
	
	
	
	
	//path.addChild(pathArea);
	//path.zIndex = 1;
	//stage.addChild (path);   // add to main stage

  
  
  
  
    //array that holds info for all frames
    var frameBuffer = {};

    //object that holds info for current frame
    var frame = {
        x: 0, 
        y: 0,
        rotation: 0
    };

    //first frame
    frameBuffer[0] = { "x" : car.position.x,  "y" : car.position.y, "rotation" : car.rotation};

    //set first frame to last frame for the first run
    var lastFrame;
    lastFrame = frameBuffer[0];
    var currentFrame;
    //start count from 1
    var count = 1;


	
	// my DUMMY DATA**********************************************************************
	var xx = 0 ;
	var yy = 0;
	var gonia=0;
	var str = "dummy";
	var index = 0
	var carPath = {x:0, y:0};   //index [0]


	
    animate();
	
	function showTrack () // car button****************************************
{
 	tracks.visible= !tracks.visible ;
}

/*
function cancelClick ()
{
 	carPath.length = 0; // empting the path array
//	stage.removeChild(path); //mporei na 8elei mono index no.....
}

*/
	
// ************************************************ LOOPA *******************************************	
    function animate() {
        requestAnimationFrame(animate);
		graphics3.lineStyle(1, 0x000000);
		graphics3.beginFill(0xFFFF0B, 0.5);
		
		if (gonia >= (2*Math.PI))
			gonia =0;
		
		//*****************************************************XORIS EKSOMALINSI!!!!!!!!!!!!!!!!!!!!!1
		// xx = (400+(275 * Math.cos(gonia)));
		//yy = (300+(275 * Math.sin(gonia)));
		
		
	//	xx = ~~(400+(275 * Math.cos(gonia)));
	//	yy = ~~ (300+(275 * Math.sin(gonia)));
	
		// 400.300 center of canvas, 275=radius
		
	xx = (400+ (Math.floor( (275 * Math.cos(gonia)) *10) ) *0.1);
	yy = (300+ (Math.floor( (275 * Math.sin(gonia)) *10) ) *0.1);
		
		
        //Set car position on each animation pass
        // var str = document.getElementById('dataDev1').textContent;
		//******************************my Dummy Data Generator *********************************************
	    
		 str = xx +"*"+yy;
        var parsed = str.split('*');

        var rotation = Math.atan2((parsed[0] - lastFrame.x), (parsed[1] - lastFrame.y)*(-1));

        currentFrame = {"x" : parsed[0], "y" : parsed[1], "rotation" : rotation};

        if ((lastFrame.x != currentFrame.x) || (lastFrame.y != currentFrame.y))
        {

        frameBuffer[count] = currentFrame;
        
        car.position.x = currentFrame.x;
        car.position.y = currentFrame.y;
        car.rotation = rotation;

		// var graphics = new PIXI.Graphics();
		//graphics.lineStyle(0);
		//graphics.beginFill(0xFFFF0B, 0.5);
		
	//	graphics.moveTo(lastFrame.x, lastFrame.y);
	//	graphics.lineTo(currentFrame.x, currentFrame.y);
		
		graphics3.drawCircle(~~currentFrame.x, ~~currentFrame.y, 2);
		
		
		//console.log (lastFrame.x +"___"+  lastFrame.y + "-----"+ currentFrame.x +"___"+ currentFrame.y);
		
		// graphics.endFill();
	
		//tracks.addChild(graphics);
		//stage.addChild (tracks);
	
		
    //    console.log("LastFrame: " + JSON.stringify(lastFrame));
    //    console.log("CurrentFrame: " + JSON.stringify(currentFrame));
		
		//graphics.lineTo(car.position.x , car.position.y);
		//stage.addChild(graphics);
		tracks.addChild(graphics3);
		
        renderer.render(stage);
        lastFrame = currentFrame;
		
		gonia = gonia+0.01;
        }
    }

	//function onDragStart(event)
	


    </script>

</body>
</html>
